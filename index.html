<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Mapbox Style Fixer</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .loading { background: #e3f2fd; color: #1565c0; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .warning { background: #fff3e0; color: #f57c00; }
        
        #map { 
            height: 500px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .logs {
            background: #263238;
            color: #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        
        .log-error { color: #ff6b6b; }
        .log-success { color: #51cf66; }
        .log-info { color: #74c0fc; }
        .log-warn { color: #ffd43b; }
        
        .fixes-applied {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .fixes-applied h4 {
            margin-top: 0;
            color: #2e7d32;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="info">
            <h1>üîß Mapbox Style Client-Side Fixer</h1>
            <p>Fetching and fixing: <code>mapbox://styles/bibleviz/cm6yc8h0i001w01quf2orebmn</code></p>
            <p>This tool automatically fixes style issues before rendering the map.</p>
            
            <div id="status" class="status loading">üîÑ Initializing...</div>
        </div>

        <div id="fixes-info"></div>

        <div id='map'></div>
        
        <div class="logs">
            <div><strong>üìã Detailed Logs:</strong></div>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        // Configuration
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYmlibGV2aXoiLCJhIjoiY2pjOTVhazJ1MDlqbzMzczFoamd3MzFnOSJ9.7k1RJ5oh-LNaYuADxsgx4Q';
        const STYLE_ID = 'cm6yc8h0i001w01quf2orebmn';
        const USERNAME = 'bibleviz';
        
        // Logging utilities
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        const fixesInfoDiv = document.getElementById('fixes-info');
        
        let appliedFixes = [];
        
        function updateStatus(message, type = 'loading') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            log(message, type);
        }
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function addFix(description) {
            appliedFixes.push(description);
            updateFixesDisplay();
        }

        function updateFixesDisplay() {
            if (appliedFixes.length === 0) return;
            
            let html = '<div class="fixes-applied"><h4>üîß Applied Fixes:</h4><ul>';
            appliedFixes.forEach(fix => html += `<li>${fix}</li>`);
            html += '</ul></div>';
            fixesInfoDiv.innerHTML = html;
        }

        // Style fixing functions
        function fixStyleJSON(styleJSON) {
            log('üîß Starting style fixes...', 'info');
            let fixedStyle = JSON.parse(JSON.stringify(styleJSON)); // Deep clone
            
            // Fix each layer
            if (fixedStyle.layers) {
                fixedStyle.layers.forEach((layer, index) => {
                    
                    // Fix 1: Remove invalid text-size-scale-range property
                    if (layer.layout && layer.layout['text-size-scale-range']) {
                        delete layer.layout['text-size-scale-range'];
                        addFix(`Removed invalid 'text-size-scale-range' property from layer "${layer.id}"`);
                        log(`Fixed: Removed text-size-scale-range from layer ${layer.id}`, 'success');
                    }
                    
                    // Fix 2: Simplify match expressions - convert array format to simple strings
                    if (layer.paint && layer.paint['circle-color'] && Array.isArray(layer.paint['circle-color'])) {
                        fixedStyle.layers[index].paint['circle-color'] = fixMatchExpression(layer.paint['circle-color']);
                        addFix(`Fixed match expression in circle-color for layer "${layer.id}"`);
                    }
                    
                    if (layer.paint && layer.paint['line-color'] && Array.isArray(layer.paint['line-color'])) {
                        fixedStyle.layers[index].paint['line-color'] = fixMatchExpression(layer.paint['line-color']);
                        addFix(`Fixed match expression in line-color for layer "${layer.id}"`);
                    }
                    
                    // Fix 3: Add missing text color for mid-level layer
                    if (layer.id === 'labels-mid-level' && layer.paint && !layer.paint['text-color']) {
                        fixedStyle.layers[index].paint['text-color'] = 'rgba(0, 0, 0, 0.7)';
                        addFix(`Added missing text-color to layer "${layer.id}"`);
                        log(`Fixed: Added text-color to ${layer.id}`, 'success');
                    }
                    
                    // Fix 4: Simplify geometry filters
                    if (layer.filter && Array.isArray(layer.filter)) {
                        const newFilter = fixGeometryFilter(layer.filter);
                        if (newFilter !== layer.filter) {
                            fixedStyle.layers[index].filter = newFilter;
                            addFix(`Simplified geometry filter for layer "${layer.id}"`);
                        }
                    }
                });
            }
            
            // Fix 5: Remove null terrain property
            if (fixedStyle.terrain === null) {
                delete fixedStyle.terrain;
                addFix(`Removed null terrain property from style`);
                log(`Fixed: Removed null terrain property`, 'success');
            }
            
            log(`üéâ Style fixes completed! Applied ${appliedFixes.length} fixes.`, 'success');
            return fixedStyle;
        }

        function fixMatchExpression(matchExpr) {
            if (!Array.isArray(matchExpr) || matchExpr[0] !== 'match') {
                return matchExpr;
            }
            
            // Create a new match expression with simplified values
            const newMatchExpr = ['match', matchExpr[1]]; // Keep the property getter
            
            // Process the cases - skip complex array values and use simple strings
            for (let i = 2; i < matchExpr.length - 1; i += 2) {
                const key = matchExpr[i];
                const value = matchExpr[i + 1];
                
                if (Array.isArray(key)) {
                    // If key is an array, use the first string value
                    const simpleKey = key.find(k => typeof k === 'string' && !k.startsWith('['));
                    if (simpleKey) {
                        newMatchExpr.push(simpleKey, value);
                    }
                } else if (typeof key === 'string' && !key.startsWith('[')) {
                    // Keep simple string keys
                    newMatchExpr.push(key, value);
                }
            }
            
            // Add the default value (last item)
            newMatchExpr.push(matchExpr[matchExpr.length - 1]);
            
            return newMatchExpr;
        }

        function fixGeometryFilter(filter) {
            // Convert match-based geometry filters to simpler == filters
            if (Array.isArray(filter) && filter[0] === 'match' && filter[1] && 
                Array.isArray(filter[1]) && filter[1][0] === 'geometry-type') {
                
                const geomType = filter[2]; // The geometry type array
                if (Array.isArray(geomType) && geomType.length === 1) {
                    // Convert to simple == filter
                    return ['==', ['geometry-type'], geomType[0]];
                }
            }
            return filter;
        }

        async function fetchAndFixStyle() {
            try {
                updateStatus('üîÑ Fetching style from Mapbox API...', 'loading');
                
                const response = await fetch(
                    `https://api.mapbox.com/styles/v1/${USERNAME}/${STYLE_ID}?access_token=${MAPBOX_TOKEN}`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const originalStyle = await response.json();
                log('‚úÖ Original style fetched successfully', 'success');
                
                updateStatus('üîß Applying fixes to style...', 'loading');
                const fixedStyle = fixStyleJSON(originalStyle);
                
                updateStatus('üó∫Ô∏è Creating map with fixed style...', 'loading');
                await createMapWithStyle(fixedStyle);
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                updateStatus('‚ùå Failed to load style', 'error');
                
                // Try fallback approach
                log('Attempting fallback approach...', 'warn');
                createFallbackMap();
            }
        }

        async function createMapWithStyle(styleJSON) {
            try {
                mapboxgl.accessToken = MAPBOX_TOKEN;
                
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: styleJSON, // Use the fixed style object directly
                    center: styleJSON.center || [0, 0],
                    zoom: styleJSON.zoom || 2,
                    bearing: styleJSON.bearing || 0,
                    pitch: styleJSON.pitch || 0
                });
                
                map.on('load', () => {
                    updateStatus('‚úÖ Success! Map loaded with fixed style', 'success');
                    log('üéâ Map rendered successfully with genealogy data!', 'success');
                    
                    // Query and log some statistics
                    setTimeout(() => {
                        try {
                            const features = map.querySourceFeatures('composite', {
                                sourceLayer: 'bible_genes_json_2'
                            });
                            log(`üìä Loaded ${features.length} features from the genealogy dataset`, 'info');
                            
                            if (features.length > 0) {
                                const pointFeatures = features.filter(f => f.geometry.type === 'Point');
                                const lineFeatures = features.filter(f => f.geometry.type === 'LineString');
                                log(`üìç Points: ${pointFeatures.length}, Lines: ${lineFeatures.length}`, 'info');
                                
                                if (pointFeatures.length > 0) {
                                    const sampleProps = Object.keys(pointFeatures[0].properties || {});
                                    log(`üè∑Ô∏è Sample properties: ${sampleProps.slice(0, 5).join(', ')}`, 'info');
                                }
                            }
                        } catch (e) {
                            log(`‚ö†Ô∏è Could not query features: ${e.message}`, 'warn');
                        }
                    }, 2000);
                });
                
                map.on('error', (e) => {
                    log(`‚ö†Ô∏è Map warning: ${e.error?.message || 'Unknown error'}`, 'warn');
                    // Don't treat warnings as fatal errors
                });
                
                map.on('styledata', () => {
                    log('üé® Style data processed successfully', 'success');
                });
                
            } catch (error) {
                log(`‚ùå Failed to create map: ${error.message}`, 'error');
                updateStatus('‚ùå Map creation failed', 'error');
                throw error;
            }
        }

        function createFallbackMap() {
            updateStatus('üîÑ Loading fallback map...', 'warning');
            
            mapboxgl.accessToken = MAPBOX_TOKEN;
            
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [1.33, -1.99], // Approximate center from your style
                zoom: 3
            });

            map.on('load', () => {
                updateStatus('‚ö†Ô∏è Fallback map loaded (style issues remain)', 'warning');
                log('Fallback basic map loaded - custom style needs manual fixing', 'warn');
            });
        }

        // Start the process
        if (typeof mapboxgl === 'undefined') {
            updateStatus('‚ùå Mapbox GL JS failed to load', 'error');
            log('Mapbox GL JS library could not be loaded from CDN', 'error');
        } else {
            log(`‚úÖ Mapbox GL JS loaded (version: ${mapboxgl.version})`, 'success');
            fetchAndFixStyle();
        }
    </script>
</body>
</html>